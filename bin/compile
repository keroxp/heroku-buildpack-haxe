#!/usr/bin/env bash

HAXE_VERSION=3.2.0
NEKO_VERSION=2.0.0

indent() {
  sed -u 's/^/       /'
}

arrow() {
  sed -u 's/^/-----> /'
}

echo "Install haxe-$HAXE_VERSION" | arrow
BUILD_DIR=$1

VENDOR_DIR="vendor"
mkdir -p $BUILD_DIR/$VENDOR_DIR

BIN_DIR=$BUILD_DIR/bin
mkdir -p $BIN_DIR

LIB_DIR=$BUILD_DIR/$VENDOR_DIR/lib
mkdir -p $LIB_DIR

HAXE_DIR=$LIB_DIR/haxe
mkdir -p $HAXE_DIR

echo "BUILD_DIR=$BUILD_DIR" | indent

cd $VENDOR_DIR

echo "Download Haxe Binary" | arrow

if [ `uname -m` = "x86_64" ]; then
  wget -c http://haxe.org/website-content/downloads/$HAXE_VERSION/downloads/haxe-$HAXE_VERSION-linux64.tar.gz
  tar xzf haxe-$HAXE_VERSION-linux64.tar.gz -C $LIB_DIR/haxe --strip-components=1
else
  wget -c http://haxe.org/website-content/downloads/$HAXE_VERSION/downloads/haxe-$HAXE_VERSION-linux32.tar.gz
  tar xzf haxe-$HAXE_VERSION-linux32.tar.gz -C $LIB_DIR/haxe --strip-components=1
fi

ln -s $HAXE_DIR/haxe $BIN_DIR/haxe
ln -s $HAXE_DIR/haxelib $BIN_DIR/haxelib
mkdir -p $HAXE_DIR/lib
chmod -R 777 $HAXE_DIR/lib
$BIN_DIR/haxelib setup $HAXE_DIR/lib

echo "exporting PATH" | indent
cd ../
PROFILE_PATH=$BUILD_DIR/.profile.d/haxe.sh
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="$PATH:$HOME/bin:$BIN_DIR"' > $PROFILE_PATH
export PATH="$PATH:$HOME/bin:$BIN_DIR"
echo $PATH | indent
echo "Done" | arrow
